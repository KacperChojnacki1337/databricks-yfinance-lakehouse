name: Databricks CD Deploy - YFinance Bronze Layer

on:
  push:
    branches:
      - main     # Trigger dla PROD
      - develop  # Trigger dla TEST
  
  # Umożliwia ręczne uruchomienie akcji z poziomu interfejsu GitHub
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Warunek (Guardrail): Akcja musi się uruchomić tylko jeśli sekrety są dostępne.
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.repository_owner != 'ghost')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Konfiguracja Databricks CLI
      - name: Setup Databricks CLI
        uses: **databricks/setup-cli@main**

      # 1. Określenie targetu na podstawie gałęzi
      - name: Determine Deployment Target (TEST/PROD)
        id: determine_target
        run: |
          # Sprawdzenie, na jaką gałąź nastąpił push
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TARGET="PROD"
          else
            TARGET="TEST"
          fi
          
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "Wybrany Target: $TARGET"

      # 2. Walidacja Databricks Bundle
      # Sprawdza poprawność pliku databricks.yml przed próbą wdrożenia.
      - name: Validate Databricks Bundle
        run: databricks bundle validate

      # 3. Wdrożenie na wybrany Target (TEST lub PROD)
      - name: Deploy to ${{ steps.determine_target.outputs.target }}
        env:
          # Użycie sekretów GitHub (muszą być ustawione w Settings -> Secrets)
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          TARGET=${{ steps.determine_target.outputs.target }}
          echo "Rozpoczynanie wdrożenia Bundle yfinance-bronze-layer na target $TARGET..."
          
          # Używamy zmiennych środowiskowych do uwierzytelnienia CLI
          databricks bundle deploy --target $TARGET

      # 4. Uruchomienie Joba po udanym wdrożeniu (opcjonalnie, ale zalecane dla CD)
      - name: Run Bronze Ingestion Job on ${{ steps.determine_target.outputs.target }}
        if: success()
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          TARGET=${{ steps.determine_target.outputs.target }}
          echo "Uruchamianie Joba bronze_ingestion na target $TARGET..."
          
          # Polecenie 'run' uruchamia Job wdrożony w kroku 3
          databricks bundle run bronze_ingestion --target $TARGET
